{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "vibe-pay-integration",
  "title": "Vibe-Pay æ•´åˆé‚è¼¯é…ç½®",
  "description": "æä¾›çµ¦ AI åŠ©æ‰‹è‡ªå‹•ç”¢ç”Ÿçµå¸³ç¨‹å¼ç¢¼çš„é…ç½®æª”",
  "version": "1.0.0",

  "system": {
    "name": "Vibe-Pay",
    "provider": "NewebPay (è—æ–°é‡‘æµ)",
    "supportedFrameworks": ["React", "Vue", "Next.js", "Express", "Fastify"],
    "database": "Supabase (PostgreSQL)"
  },

  "endpoints": {
    "singlePayment": {
      "method": "POST",
      "path": "/api/v1/payment/single",
      "description": "å–®æ¬¡ä»˜æ¬¾ - ç”¢ç”Ÿè‡ªå‹•æäº¤çš„ä»˜æ¬¾è¡¨å–®",
      "request": {
        "contentType": "application/json",
        "required": ["amount", "itemDesc", "email"],
        "optional": ["userId", "paymentMethods", "returnUrl", "notifyUrl", "clientBackUrl"],
        "schema": {
          "amount": { "type": "integer", "min": 1, "description": "é‡‘é¡(æ•´æ•¸ï¼Œæ–°å°å¹£)" },
          "itemDesc": { "type": "string", "maxLength": 50, "description": "å•†å“æè¿°" },
          "email": { "type": "string", "format": "email", "description": "ä»˜æ¬¾äºº Email" },
          "paymentMethods": { "type": "array", "items": "PaymentMethod", "description": "ä»˜æ¬¾æ–¹å¼" }
        }
      },
      "response": {
        "success": {
          "merchantOrderNo": "string - è¨‚å–®ç·¨è™Ÿ",
          "formHtml": "string - è‡ªå‹•æäº¤çš„ HTML è¡¨å–®",
          "actionUrl": "string - è—æ–°é–˜é“ URL"
        }
      }
    },

    "subscribe": {
      "method": "POST",
      "path": "/api/v1/payment/subscribe",
      "description": "å®šæœŸå®šé¡è¨‚é–±",
      "request": {
        "required": ["userId", "amount", "itemDesc", "email", "periodType", "periodPoint", "totalPeriods"],
        "schema": {
          "userId": { "type": "string", "description": "ç”¨æˆ¶ UUID" },
          "amount": { "type": "integer", "min": 1, "description": "æ¯æœŸé‡‘é¡" },
          "periodType": { "type": "enum", "values": ["D", "W", "M", "Y"], "description": "é€±æœŸé¡å‹" },
          "periodPoint": { "type": "string", "description": "æ‰£æ¬¾æ™‚é–“é»" },
          "totalPeriods": { "type": "integer", "min": 2, "max": 99, "description": "ç¸½æœŸæ•¸" }
        }
      }
    },

    "webhook": {
      "method": "POST",
      "path": "/api/payment-callback",
      "description": "è—æ–°ä»˜æ¬¾çµæœå›å‘¼",
      "security": {
        "ipWhitelist": ["175.99.72.0/24", "61.219.166.0/24"],
        "signatureVerification": "SHA256(HashKey + TradeInfo + HashIV)"
      }
    }
  },

  "paymentMethods": {
    "CREDIT": { "name": "ä¿¡ç”¨å¡", "icon": "ğŸ’³", "realtime": true },
    "WEBATM": { "name": "ç¶²è·¯ATM", "icon": "ğŸ§", "realtime": true },
    "VACC": { "name": "ATMè½‰å¸³", "icon": "ğŸ¦", "realtime": false },
    "CVS": { "name": "è¶…å•†ä»£ç¢¼", "icon": "ğŸª", "realtime": false },
    "BARCODE": { "name": "è¶…å•†æ¢ç¢¼", "icon": "ğŸ“Š", "realtime": false },
    "LINEPAY": { "name": "LINE Pay", "icon": "ğŸ’š", "realtime": true },
    "TAIWANPAY": { "name": "å°ç£Pay", "icon": "ğŸ‡¹ğŸ‡¼", "realtime": true }
  },

  "subscriptionStates": {
    "pending": { "label": "å¾…æˆæ¬Š", "color": "#FFA500", "canTransition": ["active", "cancelled"] },
    "active": { "label": "æ´»èºä¸­", "color": "#00C853", "canTransition": ["past_due", "suspended", "cancelled", "expired"] },
    "past_due": { "label": "é€¾æœŸ", "color": "#FF5722", "canTransition": ["active", "cancelled"] },
    "suspended": { "label": "æš«åœä¸­", "color": "#9E9E9E", "canTransition": ["active", "cancelled"] },
    "cancelled": { "label": "å·²å–æ¶ˆ", "color": "#F44336", "canTransition": [] },
    "expired": { "label": "å·²åˆ°æœŸ", "color": "#607D8B", "canTransition": [] }
  },

  "codeTemplates": {
    "checkoutButton": {
      "description": "çµå¸³æŒ‰éˆ•å…ƒä»¶",
      "react": "```tsx\nimport { useState } from 'react';\n\ninterface CheckoutButtonProps {\n  amount: number;\n  itemDesc: string;\n  userEmail: string;\n  onSuccess?: () => void;\n  onError?: (error: string) => void;\n}\n\nexport function CheckoutButton({\n  amount,\n  itemDesc,\n  userEmail,\n  onSuccess,\n  onError\n}: CheckoutButtonProps) {\n  const [loading, setLoading] = useState(false);\n\n  const handleCheckout = async () => {\n    setLoading(true);\n    try {\n      const response = await fetch('/api/v1/payment/single', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          amount,\n          itemDesc,\n          email: userEmail\n        })\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        // æ’å…¥è‡ªå‹•æäº¤è¡¨å–®\n        const container = document.createElement('div');\n        container.innerHTML = result.data.formHtml;\n        document.body.appendChild(container);\n        onSuccess?.();\n      } else {\n        onError?.(result.error?.message || 'ä»˜æ¬¾å¤±æ•—');\n      }\n    } catch (error) {\n      onError?.(error instanceof Error ? error.message : 'ç¶²è·¯éŒ¯èª¤');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <button\n      onClick={handleCheckout}\n      disabled={loading}\n      className=\"checkout-btn\"\n    >\n      {loading ? 'è™•ç†ä¸­...' : `ä»˜æ¬¾ NT$ ${amount.toLocaleString()}`}\n    </button>\n  );\n}\n```",
      "vue": "```vue\n<template>\n  <button\n    @click=\"handleCheckout\"\n    :disabled=\"loading\"\n    class=\"checkout-btn\"\n  >\n    {{ loading ? 'è™•ç†ä¸­...' : `ä»˜æ¬¾ NT$ ${amount.toLocaleString()}` }}\n  </button>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref } from 'vue';\n\nconst props = defineProps<{\n  amount: number;\n  itemDesc: string;\n  userEmail: string;\n}>();\n\nconst emit = defineEmits<{\n  success: [];\n  error: [message: string];\n}>();\n\nconst loading = ref(false);\n\nasync function handleCheckout() {\n  loading.value = true;\n  try {\n    const response = await fetch('/api/v1/payment/single', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        amount: props.amount,\n        itemDesc: props.itemDesc,\n        email: props.userEmail\n      })\n    });\n\n    const result = await response.json();\n\n    if (result.success) {\n      const container = document.createElement('div');\n      container.innerHTML = result.data.formHtml;\n      document.body.appendChild(container);\n      emit('success');\n    } else {\n      emit('error', result.error?.message || 'ä»˜æ¬¾å¤±æ•—');\n    }\n  } catch (error) {\n    emit('error', error instanceof Error ? error.message : 'ç¶²è·¯éŒ¯èª¤');\n  } finally {\n    loading.value = false;\n  }\n}\n</script>\n```"
    },

    "subscribeButton": {
      "description": "è¨‚é–±æŒ‰éˆ•å…ƒä»¶",
      "react": "```tsx\nimport { useState } from 'react';\n\ninterface SubscribeButtonProps {\n  userId: string;\n  planName: string;\n  amount: number;\n  periodType: 'D' | 'W' | 'M' | 'Y';\n  periodPoint: string;\n  totalPeriods: number;\n  userEmail: string;\n}\n\nexport function SubscribeButton({\n  userId,\n  planName,\n  amount,\n  periodType,\n  periodPoint,\n  totalPeriods,\n  userEmail\n}: SubscribeButtonProps) {\n  const [loading, setLoading] = useState(false);\n\n  const periodLabels = { D: 'æ—¥', W: 'é€±', M: 'æœˆ', Y: 'å¹´' };\n\n  const handleSubscribe = async () => {\n    setLoading(true);\n    try {\n      const response = await fetch('/api/v1/payment/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          userId,\n          amount,\n          itemDesc: planName,\n          email: userEmail,\n          periodType,\n          periodPoint,\n          totalPeriods\n        })\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        const container = document.createElement('div');\n        container.innerHTML = result.data.formHtml;\n        document.body.appendChild(container);\n      }\n    } catch (error) {\n      console.error('è¨‚é–±å¤±æ•—:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <button onClick={handleSubscribe} disabled={loading}>\n      {loading ? 'è™•ç†ä¸­...' : `è¨‚é–± ${planName} (NT$ ${amount}/${periodLabels[periodType]})`}\n    </button>\n  );\n}\n```"
    },

    "apiRoute": {
      "description": "API è·¯ç”±è™•ç†å™¨",
      "nextjs": "```typescript\n// app/api/v1/payment/single/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\nimport { initializeVibePay } from '@/payment';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.VITE_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst vibePay = initializeVibePay(supabase);\n\nexport async function POST(request: NextRequest) {\n  const body = await request.json();\n  const requestId = crypto.randomUUID();\n\n  const result = await vibePay.api.handleSinglePayment(body, requestId);\n\n  return NextResponse.json(result, {\n    status: result.success ? 200 : 400\n  });\n}\n```",
      "express": "```typescript\n// routes/payment.ts\nimport { Router } from 'express';\nimport { initializeVibePay } from '../payment';\nimport { supabase } from '../lib/supabase';\n\nconst router = Router();\nconst vibePay = initializeVibePay(supabase);\n\nrouter.post('/single', async (req, res) => {\n  const result = await vibePay.api.handleSinglePayment(req.body);\n  res.status(result.success ? 200 : 400).json(result);\n});\n\nrouter.post('/subscribe', async (req, res) => {\n  const result = await vibePay.api.handleSubscribe(req.body);\n  res.status(result.success ? 200 : 400).json(result);\n});\n\nrouter.post('/callback', async (req, res) => {\n  const result = await vibePay.api.handlePaymentCallback(req.body, req.ip);\n  res.status(result.success ? 200 : 400).json(result);\n});\n\nexport default router;\n```"
    },

    "webhookHandler": {
      "description": "Webhook è™•ç†å™¨",
      "nextjs": "```typescript\n// app/api/payment-callback/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\nimport { initializeVibePay } from '@/payment';\nimport { createClient } from '@supabase/supabase-js';\n\nconst supabase = createClient(\n  process.env.VITE_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nconst vibePay = initializeVibePay(supabase);\n\nexport async function POST(request: NextRequest) {\n  const body = await request.json();\n  const clientIP = request.headers.get('x-forwarded-for') ||\n                   request.headers.get('x-real-ip') ||\n                   '127.0.0.1';\n\n  const result = await vibePay.api.handlePaymentCallback(body, clientIP);\n\n  return NextResponse.json(result);\n}\n```"
    }
  },

  "aiInstructions": {
    "whenGeneratingCode": [
      "é‡‘é¡ (amount) å¿…é ˆæ˜¯æ­£æ•´æ•¸ï¼Œä¸æ¥å—å°æ•¸",
      "å•†å“æè¿° (itemDesc) æœ€å¤š 50 å­—å…ƒ",
      "Email ç‚ºå¿…å¡«æ¬„ä½",
      "è¨‚é–±å¿…é ˆæä¾› userId",
      "periodPoint æ ¼å¼ä¾ periodType è€Œå®šï¼šD=ç„¡é™åˆ¶, W=1-7, M=1-31, Y=MMDD",
      "ä½¿ç”¨ document.body.insertAdjacentHTML æ’å…¥è¡¨å–®",
      "è¡¨å–®æœƒè‡ªå‹•æäº¤ï¼Œç„¡éœ€æ‰‹å‹•è™•ç†"
    ],
    "securityNotes": [
      "æ°¸é é©—è­‰ Webhook ä¾†æº IP",
      "æ°¸é é©—è­‰ TradeSha ç°½å",
      "ä¸è¦åœ¨å‰ç«¯æš´éœ² HashKey/HashIV",
      "ä½¿ç”¨ HTTPS å‚³è¼¸æ‰€æœ‰è«‹æ±‚",
      "å¯¦ä½œ CSRF ä¿è­·"
    ],
    "errorHandling": [
      "æª¢æŸ¥ response.success ç‹€æ…‹",
      "è™•ç†ç¶²è·¯éŒ¯èª¤ (try-catch)",
      "é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶",
      "è¨˜éŒ„éŒ¯èª¤åˆ°æ—¥èªŒç³»çµ±"
    ]
  },

  "testCredentials": {
    "note": "åƒ…ä¾›æ¸¬è©¦ç’°å¢ƒä½¿ç”¨ï¼Œè«‹å‹¿ç”¨æ–¼æ­£å¼ç’°å¢ƒ",
    "sandbox": {
      "url": "https://ccore.newebpay.com/MPG/mpg_gateway",
      "merchantId": "è«‹è‡³è—æ–°æ¸¬è©¦å¾Œå°ç”³è«‹",
      "hashKeyLength": 32,
      "hashIVLength": 16
    },
    "testCards": [
      { "number": "4000-2211-1111-1111", "expiry": "ä»»æ„æœªä¾†æ—¥æœŸ", "cvv": "ä»»æ„3ç¢¼", "result": "æˆåŠŸ" },
      { "number": "4000-2222-2222-2222", "expiry": "ä»»æ„æœªä¾†æ—¥æœŸ", "cvv": "ä»»æ„3ç¢¼", "result": "å¤±æ•—" }
    ]
  }
}
