# ====================================
# CI/CD 自動化測試與部署
# ====================================
#
# 資安規範遵循：
# - 自動化驗證：每次 Push/PR 自動執行測試
# - 測試先行：確保所有測試通過才能合併
# - 依賴審核：自動執行安全掃描

name: CI - 自動化測試

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================
  # 程式碼品質檢查
  # ============================================
  lint-and-typecheck:
    name: 程式碼品質檢查
    runs-on: ubuntu-latest

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安裝依賴
        run: npm ci

      - name: TypeScript 型別檢查
        run: npx tsc --noEmit

  # ============================================
  # 單元測試
  # ============================================
  unit-tests:
    name: 單元測試
    runs-on: ubuntu-latest
    needs: lint-and-typecheck

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安裝依賴
        run: npm ci

      - name: 執行單元測試
        run: npm test

      - name: 上傳測試報告
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: coverage/
          retention-days: 7

  # ============================================
  # 安全掃描
  # ============================================
  security-scan:
    name: 安全掃描
    runs-on: ubuntu-latest

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安裝依賴
        run: npm ci

      - name: 依賴安全掃描
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: 檢查機密檔案洩漏
        run: |
          echo "檢查是否有機密檔案..."
          if [ -f ".env" ]; then
            echo "::error::發現 .env 檔案！請確認已加入 .gitignore"
            exit 1
          fi
          if [ -f "credentials.json" ]; then
            echo "::error::發現 credentials.json！請確認已加入 .gitignore"
            exit 1
          fi
          echo "✅ 未發現機密檔案"

  # ============================================
  # 建構測試
  # ============================================
  build:
    name: 建構測試
    runs-on: ubuntu-latest
    needs: [unit-tests, security-scan]

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安裝依賴
        run: npm ci

      - name: 建構專案
        run: npm run build

      - name: 上傳建構產物
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # ============================================
  # 測試覆蓋率報告
  # ============================================
  coverage-report:
    name: 測試覆蓋率報告
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: 安裝依賴
        run: npm ci

      - name: 產生覆蓋率報告
        run: npm test -- --coverage
        continue-on-error: true

      - name: 顯示覆蓋率摘要
        run: |
          echo "## 測試覆蓋率報告" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "✅ 覆蓋率報告已產生" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ 覆蓋率報告未產生" >> $GITHUB_STEP_SUMMARY
          fi
